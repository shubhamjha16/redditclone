{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>Chat with Our Bot</h2>
    <div id="chat-history" style="height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px;">
        <!-- Chat messages will appear here -->
    </div>
    <div class="input-group mb-3">
        <input type="text" id="chat-input" class="form-control" placeholder="Type your message...">
        <button id="send-button" class="btn btn-primary">Send</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        function appendMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to bottom
        }

        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === "") {
                return;
            }

            appendMessage("You", userMessage);
            chatInput.value = "";

            try {
                // Construct the URL for the /chat endpoint using Flask's url_for
                // This requires url_for to be available in the template context,
                // or you might need to hardcode/construct it carefully if not.
                // For simplicity, hardcoding for now, assuming blueprint is registered at /chatbot.
                // A better way in Flask is to pass this URL from the Python route or use url_for if Jinja utils are available in static JS.
                const response = await fetch("{{ url_for('chatbot.chat_api') }}", { // Corrected to use url_for
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // If you have CSRF protection, you might need to include a CSRF token
                        // 'X-CSRFToken': '{{ csrf_token() }}' // Example if using Flask-WTF CSRF
                    },
                    body: JSON.stringify({ "message": userMessage })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null); // Try to parse error, otherwise null
                    const errorMessage = errorData && errorData.error ? errorData.error : `HTTP error ${response.status}`;
                    appendMessage("Bot", `Error: ${errorMessage}`);
                    return;
                }

                const data = await response.json();
                appendMessage("Bot", data.response);

            } catch (error) {
                console.error("Error sending message:", error);
                appendMessage("Bot", "Error: Could not connect to the chatbot. Please try again later.");
            }
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Initial bot message (optional)
        appendMessage("Bot", "Hello! How can I help you today?");
    });
</script>
{% endblock %}
